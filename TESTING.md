# Инструкция по тестированию голосового виджета

## Подготовка к тестированию

### 1. Получение LiveKit креденшиалов

1. Зарегистрируйтесь на [LiveKit Cloud](https://cloud.livekit.io/)
2. Создайте новый проект
3. Получите следующие данные:
   - API Key
   - API Secret  
   - WebSocket URL (wss://your-project.livekit.cloud)

### 2. Настройка переменных окружения

```bash
# Скопируйте пример конфигурации
cp .env.example .env

# Отредактируйте .env файл и добавьте ваши LiveKit креды
nano .env
```

Заполните реальными значениями:
```env
LIVEKIT_API_KEY=devkey_xxxxxxxxx
LIVEKIT_API_SECRET=your_secret_key_here
LIVEKIT_URL=wss://your-project.livekit.cloud
```

### 3. Установка зависимостей

```bash
# Установка основных зависимостей
npm install

# Установка зависимостей frontend
npm run install-frontend

# Установка зависимостей API (Python)
pip install -r api/requirements.txt
```

## Локальное тестирование

### 1. Запуск в режиме разработки

```bash
# Запуск всех сервисов одновременно
npm run dev
```

Это запустит:
- Frontend на порту 3000 (http://localhost:3000)
- API сервер на порту 3001 (для Vercel dev)

### 2. Альтернативный запуск (по отдельности)

```bash
# Терминал 1: Frontend
cd frontend
npm run dev

# Терминал 2: API
vercel dev
```

### 3. Проверка API

Проверьте, что API работает:

```bash
# Тест генерации токена
curl -X POST http://localhost:3000/api/token \
  -H "Content-Type: application/json" \
  -d '{"roomName": "test-room", "participantName": "test-user"}'
```

Ожидаемый ответ:
```json
{
  "token": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "url": "wss://your-project.livekit.cloud"
}
```

## Тестирование виджета

### 1. Основное приложение

Откройте http://localhost:3000 в браузере:

1. **Проверка разрешений**: Браузер должен запросить разрешение на микрофон
2. **Подключение**: Нажмите зеленую кнопку подключения
3. **Статус**: Проверьте, что статус изменился на "Подключен"
4. **Микрофон**: Протестируйте включение/выключение микрофона
5. **Качество**: Проверьте индикатор качества соединения

### 2. iframe виджет

Откройте http://localhost:3000/widget в браузере:

1. **Компактный режим**: Проверьте базовую функциональность
2. **Расширенный режим**: Нажмите кнопку расширения
3. **Транскрипция**: Если включена, проверьте отображение

### 3. Тестирование интеграции iframe

Создайте тестовый HTML файл:

```bash
# Создайте файл test-integration.html
cat > test-integration.html << 'EOF'
<!DOCTYPE html>
<html>
<head>
    <title>Тест интеграции виджета</title>
</head>
<body>
    <h1>Тестовая страница</h1>
    <p>Виджет должен появиться в правом нижнем углу:</p>
    
    <iframe
        src="http://localhost:3000/widget?roomName=test-room&enableTranscription=true"
        style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 300px;
            height: 80px;
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
        "
        allow="microphone"
        title="Голосовой помощник"
    ></iframe>
</body>
</html>
EOF

# Откройте файл в браузере
open test-integration.html
```

## Тестирование функциональности

### 1. Проверка подключения

- [ ] Виджет загружается без ошибок
- [ ] Кнопка подключения работает
- [ ] Статус меняется с "Не подключен" на "Подключение..." на "Подключен"
- [ ] Индикатор качества соединения отображается

### 2. Проверка аудио

- [ ] Запрос разрешения микрофона работает
- [ ] Кнопка микрофона включает/выключает запись
- [ ] Визуальная индикация записи (pulse effect) работает
- [ ] Звук передается (можно проверить в LiveKit Console)

### 3. Проверка UI

- [ ] Компактный режим отображается корректно
- [ ] Расширенный режим открывается/закрывается
- [ ] Все иконки и анимации работают
- [ ] Responsive дизайн работает на мобильных

### 4. Проверка iframe

- [ ] Виджет корректно встраивается в iframe
- [ ] Параметры URL применяются (roomName, theme и т.д.)
- [ ] PostMessage коммуникация работает
- [ ] Безопасность iframe (разрешения микрофона)

## Отладка проблем

### Частые проблемы

1. **"Missing LiveKit credentials"**
   - Проверьте .env файл
   - Убедитесь, что переменные окружения загружены

2. **"WebRTC is not supported"**
   - Используйте современный браузер (Chrome, Firefox, Safari)
   - Убедитесь, что сайт работает по HTTPS в продакшене

3. **"Microphone permission denied"**
   - Разрешите доступ к микрофону в браузере
   - Проверьте настройки приватности браузера

4. **Ошибки подключения к LiveKit**
   - Проверьте правильность URL LiveKit
   - Убедитесь, что проект LiveKit активен
   - Проверьте квоты и лимиты

### Логи для отладки

```bash
# Проверка логов frontend
# Откройте DevTools в браузере (F12) и посмотрите Console

# Проверка логов API
# Логи Vercel dev отображаются в терминале

# Проверка логов LiveKit
# Откройте LiveKit Console для мониторинга соединений
```

### Инструменты для отладки

1. **Browser DevTools**: Проверка JS ошибок и сетевых запросов
2. **LiveKit Console**: Мониторинг соединений и участников
3. **Network tab**: Проверка API запросов и WebSocket соединений

## Тестирование с реальным голосовым агентом

Для полного тестирования с вашим существующим голосовым агентом:

1. **Интеграция с minskworld-audio**: Добавьте логику агента в API
2. **Настройка STT/TTS**: Интегрируйте Deepgram и OpenAI TTS
3. **Обработка событий**: Настройте обработку голосовых команд

## Следующие шаги

После успешного локального тестирования:

1. **Деплой на Vercel**: `npm run deploy:vercel`
2. **Настройка переменных окружения** в Vercel Dashboard
3. **Тестирование продакшен версии**
4. **Интеграция на реальном сайте** 